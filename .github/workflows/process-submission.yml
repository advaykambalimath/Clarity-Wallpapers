name: Process Wallpaper Submission
on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  process-submission:
    if: startsWith(github.event.issue.title, '[Submission]')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Parse Issue Body
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Extract JSON from issue body
          JSON_BODY="$ISSUE_BODY"
          
          # Use jq to parse the JSON and extract variables
          TITLE=$(echo "$JSON_BODY" | jq -r '.title')
          AUTHOR=$(echo "$JSON_BODY" | jq -r '.author')
          VIDEO_URL=$(echo "$JSON_BODY" | jq -r '.video_url')
          THUMBNAIL_URL=$(echo "$JSON_BODY" | jq -r '.thumbnail_url')
          RESOLUTION=$(echo "$JSON_BODY" | jq -r '.resolution')
          SIZE_MB=$(echo "$JSON_BODY" | jq -r '.size_mb')
          DURATION=$(echo "$JSON_BODY" | jq -r '.duration')
          COLORS=$(echo "$JSON_BODY" | jq -c '.colors')
          CATEGORIES=$(echo "$JSON_BODY" | jq -c '.categories')
          BIO=$(echo "$JSON_BODY" | jq -r '.author_bio')
          
          {
            echo "title=$TITLE"
            echo "author=$AUTHOR"
            echo "video_url=$VIDEO_URL"
            echo "thumbnail_url=$THUMBNAIL_URL"
            echo "resolution=$RESOLUTION"
            echo "size_mb=$SIZE_MB"
            echo "duration=$DURATION"
            echo "colors=$COLORS"
            echo "categories=$CATEGORIES"
            echo "bio<<EOF"
            echo "$BIO"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Download Files
        run: |
          curl -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" --retry 5 --retry-delay 10 --connect-timeout 60 --max-time 600 "${{ steps.parse.outputs.video_url }}" -o video.mp4
          curl -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" --retry 5 --retry-delay 10 --connect-timeout 60 --max-time 600 "${{ steps.parse.outputs.thumbnail_url }}" -o thumbnail.jpg

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "storage-v1"
          files: |
            video.mp4
            thumbnail.jpg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Release URLs
        id: urls
        run: |
          # Construct the permanent GitHub Release URLs
          REPO="${{ github.repository }}"
          TAG="storage-v1"
          
          # We need unique names to avoid overwriting. Using Issue Number.
          mv video.mp4 "video-${{ github.event.issue.number }}.mp4"
          mv thumbnail.jpg "thumbnail-${{ github.event.issue.number }}.jpg"
          
          VIDEO_PERMA_URL="https://github.com/$REPO/releases/download/$TAG/video-${{ github.event.issue.number }}.mp4"
          THUMB_PERMA_URL="https://github.com/$REPO/releases/download/$TAG/thumbnail-${{ github.event.issue.number }}.jpg"
          
          echo "video_perma_url=$VIDEO_PERMA_URL" >> $GITHUB_OUTPUT
          echo "thumb_perma_url=$THUMB_PERMA_URL" >> $GITHUB_OUTPUT

      - name: Re-upload renamed files
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "storage-v1"
          files: |
            video-${{ github.event.issue.number }}.mp4
            thumbnail-${{ github.event.issue.number }}.jpg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Catalog
        env:
          TITLE: ${{ steps.parse.outputs.title }}
          AUTHOR: ${{ steps.parse.outputs.author }}
          VIDEO: ${{ steps.urls.outputs.video_perma_url }}
          THUMB: ${{ steps.urls.outputs.thumb_perma_url }}
          RESOLUTION: ${{ steps.parse.outputs.resolution }}
          SIZE: ${{ steps.parse.outputs.size_mb }}
          DURATION: ${{ steps.parse.outputs.duration }}
          BIO: ${{ steps.parse.outputs.bio }}
          COLORS: ${{ steps.parse.outputs.colors }}
          CATEGORIES: ${{ steps.parse.outputs.categories }}
          ISSUE_ID: ${{ github.event.issue.number }}
        run: |
          # Create new JSON object
          NEW_ENTRY=$(jq -n \
            --arg title "$TITLE" \
            --arg author "$AUTHOR" \
            --arg video "$VIDEO" \
            --arg thumb "$THUMB" \
            --arg resolution "$RESOLUTION" \
            --arg size "$SIZE" \
            --arg duration "$DURATION" \
            --arg bio "$BIO" \
            --arg id "$ISSUE_ID" \
            --argjson colors "$COLORS" \
            --argjson categories "$CATEGORIES" \
            '{id: $id, title: $title, author: $author, videoURL: $video, thumbnailURL: $thumb, downloads: 0, resolution: $resolution, sizeMB: $size, duration: $duration, author_bio: $bio, colors: $colors, categories: $categories}')
          
          # Append to array in catalog.json
          jq ". + [$NEW_ENTRY]" catalog.json > temp.json && mv temp.json catalog.json

      - name: Commit Changes
        run: |
          git config user.name "WallpaperBot"
          git config user.email "bot@noreply.github.com"
          git add catalog.json
          git commit -m "Add wallpaper: ${{ steps.parse.outputs.title }}"
          git push

      - name: Close Issue
        uses: peter-evans/close-issue@v3
        with:
          comment: "Successfully published! Your wallpaper is now live."
