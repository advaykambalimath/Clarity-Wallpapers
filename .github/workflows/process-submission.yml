name: Process Wallpaper Submission
on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  process-submission:
    if: startsWith(github.event.issue.title, '[Submission]')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Parse Issue Body
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Use jq to parse the JSON from the environment variable
          TITLE=$(echo "$ISSUE_BODY" | jq -r '.title')
          AUTHOR=$(echo "$ISSUE_BODY" | jq -r '.author')
          VIDEO_URL=$(echo "$ISSUE_BODY" | jq -r '.video_url')
          THUMBNAIL_URL=$(echo "$ISSUE_BODY" | jq -r '.thumbnail_url')
          RESOLUTION=$(echo "$ISSUE_BODY" | jq -r '.resolution')
          SIZE_MB=$(echo "$ISSUE_BODY" | jq -r '.size_mb')
          COLORS=$(echo "$ISSUE_BODY" | jq -r '.colors // [] | @json')
          CATEGORIES=$(echo "$ISSUE_BODY" | jq -r '.categories // [] | @json')
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "video_url=$VIDEO_URL" >> $GITHUB_OUTPUT
          echo "thumbnail_url=$THUMBNAIL_URL" >> $GITHUB_OUTPUT
          echo "resolution=$RESOLUTION" >> $GITHUB_OUTPUT
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "colors=$COLORS" >> $GITHUB_OUTPUT
          echo "categories=$CATEGORIES" >> $GITHUB_OUTPUT

      - name: Download Files
        run: |
          curl -L "${{ steps.parse.outputs.video_url }}" -o video.mp4
          curl -L "${{ steps.parse.outputs.thumbnail_url }}" -o thumbnail.jpg

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "storage-v1"
          files: |
            video.mp4
            thumbnail.jpg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Release URLs
        id: urls
        run: |
          REPO="${{ github.repository }}"
          TAG="storage-v1"
          ISSUE_ID="${{ github.event.issue.number }}"
          
          mv video.mp4 "video-$ISSUE_ID.mp4"
          mv thumbnail.jpg "thumbnail-$ISSUE_ID.jpg"
          
          VIDEO_PERMA_URL="https://github.com/$REPO/releases/download/$TAG/video-$ISSUE_ID.mp4"
          THUMB_PERMA_URL="https://github.com/$REPO/releases/download/$TAG/thumbnail-$ISSUE_ID.jpg"
          
          echo "video_perma_url=$VIDEO_PERMA_URL" >> $GITHUB_OUTPUT
          echo "thumb_perma_url=$THUMB_PERMA_URL" >> $GITHUB_OUTPUT

      - name: Re-upload renamed files
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "storage-v1"
          files: |
            video-${{ github.event.issue.number }}.mp4
            thumbnail-${{ github.event.issue.number }}.jpg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Catalog
        run: |
          UUID=$(uuidgen)
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Extract colors and categories properly
          COLORS='${{ steps.parse.outputs.colors }}'
          CATEGORIES='${{ steps.parse.outputs.categories }}'
          
          NEW_ENTRY=$(jq -n \
            --arg id "$UUID" \
            --arg title "${{ steps.parse.outputs.title }}" \
            --arg author "${{ steps.parse.outputs.author }}" \
            --arg video "${{ steps.urls.outputs.video_perma_url }}" \
            --arg thumb "${{ steps.urls.outputs.thumb_perma_url }}" \
            --arg date "$DATE" \
            --arg res "${{ steps.parse.outputs.resolution }}" \
            --arg size "${{ steps.parse.outputs.size_mb }}" \
            --argjson cols "$COLORS" \
            --argjson cats "$CATEGORIES" \
            '{
              id: $id, 
              title: $title, 
              authorName: $author, 
              videoURL: $video, 
              thumbnailURL: $thumb, 
              createdAt: $date,
              isPublic: true,
              resolution: $res,
              sizeMB: $size,
              duration: "00:00",
              downloadCount: 0,
              primaryColor: ($cols[0] // null),
              secondaryColor: ($cols[1] // null),
              categories: $cats
            }')
          
          if [ ! -s catalog.json ] || ! jq -e . catalog.json >/dev/null 2>&1; then
            echo "[]" > catalog.json
          fi
          
          jq ". + [$NEW_ENTRY]" catalog.json > temp.json && mv temp.json catalog.json

      - name: Commit Changes
        run: |
          git config user.name "WallpaperBot"
          git config user.email "bot@noreply.github.com"
          git add catalog.json
          git commit -m "Add wallpaper: ${{ steps.parse.outputs.title }}"
          git push

      - name: Close Issue
        uses: peter-evans/close-issue@v3
        with:
          comment: "Published with analysis!"
