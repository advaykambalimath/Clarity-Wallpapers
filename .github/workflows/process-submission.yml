name: Process Wallpaper Submission
on:
  issues:
    types: [opened]
permissions:
  contents: write
  issues: write
jobs:
  process-submission:
    if: startsWith(github.event.issue.title, '[Submission]')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Parse Issue Body
        id: parse
        run: |
          # Extract values directly from the event payload using jq
          # This avoids shell injection completely by never putting the body in a shell variable first
          
          TITLE=$(jq -r '.issue.body | fromjson | .title' "$GITHUB_EVENT_PATH")
          AUTHOR=$(jq -r '.issue.body | fromjson | .author' "$GITHUB_EVENT_PATH")
          VIDEO_URL=$(jq -r '.issue.body | fromjson | .video_url' "$GITHUB_EVENT_PATH")
          THUMBNAIL_URL=$(jq -r '.issue.body | fromjson | .thumbnail_url' "$GITHUB_EVENT_PATH")
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "video_url=$VIDEO_URL" >> $GITHUB_OUTPUT
          echo "thumbnail_url=$THUMBNAIL_URL" >> $GITHUB_OUTPUT
      - name: Download Files
        run: |
          curl -L "${{ steps.parse.outputs.video_url }}" -o video.mp4
          curl -L "${{ steps.parse.outputs.thumbnail_url }}" -o thumbnail.jpg
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "storage-v1"
          files: |
            video.mp4
            thumbnail.jpg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Get Release URLs
        id: urls
        run: |
          # Construct the permanent GitHub Release URLs
          REPO="${{ github.repository }}"
          TAG="storage-v1"
          
          # We need unique names to avoid overwriting. Using Issue Number.
          mv video.mp4 "video-${{ github.event.issue.number }}.mp4"
          mv thumbnail.jpg "thumbnail-${{ github.event.issue.number }}.jpg"
          
          VIDEO_PERMA_URL="https://github.com/$REPO/releases/download/$TAG/video-${{ github.event.issue.number }}.mp4"
          THUMB_PERMA_URL="https://github.com/$REPO/releases/download/$TAG/thumbnail-${{ github.event.issue.number }}.jpg"
          
          echo "video_perma_url=$VIDEO_PERMA_URL" >> $GITHUB_OUTPUT
          echo "thumb_perma_url=$THUMB_PERMA_URL" >> $GITHUB_OUTPUT
      - name: Re-upload renamed files
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "storage-v1"
          files: |
            video-${{ github.event.issue.number }}.mp4
            thumbnail-${{ github.event.issue.number }}.jpg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Update Catalog
        run: |
          # Create new JSON object
          NEW_ENTRY=$(jq -n \
            --arg title "${{ steps.parse.outputs.title }}" \
            --arg author "${{ steps.parse.outputs.author }}" \
            --arg video "${{ steps.urls.outputs.video_perma_url }}" \
            --arg thumb "${{ steps.urls.outputs.thumb_perma_url }}" \
            '{id: "'"${{ github.event.issue.number }}"'", title: $title, author: $author, videoURL: $video, thumbnailURL: $thumb, downloads: 0}')
          
          # Append to array in catalog.json
          jq ". + [$NEW_ENTRY]" catalog.json > temp.json && mv temp.json catalog.json
      - name: Commit Changes
        run: |
          git config user.name "WallpaperBot"
          git config user.email "bot@noreply.github.com"
          git add catalog.json
          git commit -m "Add wallpaper: ${{ steps.parse.outputs.title }}"
          git push
      - name: Close Issue
        uses: peter-evans/close-issue@v3
        with:
          comment: "Successfully published! Your wallpaper is now live."
